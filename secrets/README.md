# Secrets Management Guide

This directory contains tools and documentation for managing secrets across different environments.

## Quick Start

```bash
# Run the bootstrap script to initialize secrets
./secrets/bootstrap-secrets.sh

# Source secrets functions in your shell (loaded automatically via loader.sh)
source shell/functions/secrets.sh

# Get a secret
get_secret "homebrew/github-token"

# Set a secret (adds to the structured 1Password item)
set_secret "homebrew/github-token" "ghp_your_token_here"
```

---

## Storage Strategy

```
Identity & credentials (git name, email, signing keys, tokens)
  ↓
  1Password: Single "ns-bootstrap" secure note with sections
  (macOS) / pass structured paths (Ubuntu)

Machine-specific config (paths, non-secret settings)
  ↓
  ~/.config/ns-bootstrap/config (sourced by loader.sh)

Container secrets (DB passwords, service keys)
  ↓
  .env files (gitignored)

System integration (SSH keys, certificates)
  ↓
  macOS Keychain / gnome-keyring

Temporary secrets (session tokens)
  ↓
  Environment variables
```

### 1Password Structure

All bootstrap-managed secrets live in a **single Secure Note** called `ns-bootstrap`:

```
1Password Vault: Personal
└── ns-bootstrap  (Secure Note, tag: managed:ns-bootstrap)
    ├── Section: Git Personal
    │   ├── name           = "Your Name"
    │   ├── email          = "you@example.com"
    │   └── signing_key    = "ssh-ed25519 AAAA..."
    ├── Section: Git Work
    │   ├── name           = "Your Name"
    │   ├── email          = "you@company.com"
    │   ├── signing_key    = "ssh-ed25519 AAAA..."
    │   └── repo_dir       = "/shared/clients/repositories/"
    ├── Section: Tokens
    │   └── homebrew_github = "ghp_..."
    └── Section: Network
        └── backup_password = "..."
```

Read with: `op read "op://Personal/ns-bootstrap/Git Personal/name"`

The item is tagged `managed:ns-bootstrap` with a note:
> *Managed by ns-bootstrap bootstrap-secrets.sh. Do not modify manually.*

### Local Config File

Non-secret, machine-specific settings are stored in `~/.config/ns-bootstrap/config`:

```bash
# Generated by secrets/bootstrap-secrets.sh
DATA_DIR="/Users/Shared"
OP_SSH_SIGN_PATH="/Applications/1Password.app/Contents/MacOS/op-ssh-sign"
GIT_CREDENTIAL_HELPER="osxkeychain"
MAC_ADDRESS="aa:bb:cc:dd:ee:ff"  # optional
```

This file is sourced by `shell/loader.sh` at shell startup — no 1Password auth needed.

### pass Structure (Ubuntu)

```
~/.password-store/
└── ns-bootstrap/
    ├── git-personal/
    │   ├── name
    │   ├── email
    │   └── signing-key
    ├── git-work/
    │   ├── name
    │   ├── email
    │   ├── signing-key
    │   └── repo-dir
    ├── tokens/
    │   └── homebrew-github
    └── network/
        └── backup-password
```

---

## Unified API

All secrets are accessed through a unified `get_secret()` function. It maps flat names like `git/name-personal` to the structured 1Password/pass paths automatically:

```bash
# Auto-detect provider based on OS
get_secret "git/name-personal"     # → op://Personal/ns-bootstrap/Git Personal/name
get_secret "homebrew/github-token" # → op://Personal/ns-bootstrap/Tokens/homebrew_github

# Explicitly specify provider
get_secret "secret-name" 1password
get_secret "secret-name" pass
get_secret "secret-name" keychain
get_secret "secret-name" env
```

---

## Setup Instructions

### macOS Setup (1Password CLI)

1. **Install 1Password CLI:**
   ```bash
   brew install --cask 1password-cli
   ```

2. **Sign in to 1Password:**
   ```bash
   eval "$(op signin)"
   ```

3. **Run bootstrap:**
   ```bash
   ./secrets/bootstrap-secrets.sh
   ```
   This creates the `ns-bootstrap` secure note with all your git config, writes `~/.config/ns-bootstrap/config`, and processes `.gitconfig` templates.

4. **Read secrets:**
   ```bash
   # Via wrapper
   get_secret "git/name-personal"

   # Direct 1Password read
   op read "op://Personal/ns-bootstrap/Git Personal/email"
   ```

### Ubuntu Setup (pass)

1. **Install pass:**
   ```bash
   sudo apt install -y pass gnupg2
   ```

2. **Generate GPG key** (if you don't have one):
   ```bash
   gpg --full-generate-key
   ```

3. **Initialize pass:**
   ```bash
   gpg --list-keys
   pass init YOUR_GPG_KEY_ID
   ```

4. **Run bootstrap:**
   ```bash
   ./secrets/bootstrap-secrets.sh
   ```

---

## Template System

Configuration files with sensitive data are stored as `.template` files with `${PLACEHOLDER}` values.

### Available Templates

1. **[dotfiles/git/.gitconfig.template](../dotfiles/git/.gitconfig.template)**
   - Placeholders: `${GIT_NAME_PERSONAL}`, `${GIT_EMAIL_PERSONAL}`, `${GIT_SIGNING_KEY}`, `${OP_SSH_SIGN_PATH}`, `${GIT_CREDENTIAL_HELPER}`
   - Output: `~/.gitconfig`

2. **[dotfiles/git/.gitconfig-work.template](../dotfiles/git/.gitconfig-work.template)**
   - Placeholders: `${GIT_NAME_WORK}`, `${GIT_EMAIL_WORK}`, `${WORK_SIGNING_KEY}`, `${WORK_GPG_SECTION}`, `${WORK_REPO_DIR}`
   - Output: `~/.gitconfig-work`

### Processing Templates

The bootstrap script automatically processes templates with backup:

```bash
./secrets/bootstrap-secrets.sh
# Backs up existing files to ~/.dotfiles-backup/<timestamp>/
# Then writes processed templates
```

---

## Convenience Functions

```bash
# Check what secrets manager is available
secrets_available  # Returns: 1password, pass, keychain, or none

# List all secrets
secrets_list

# Interactive secret selection (requires fzf)
secret=$(secrets_select)

# Common secret shortcuts
get_github_token
get_homebrew_token
get_aws_access_key
get_aws_secret_key

# Export AWS credentials
export_aws_credentials
```

---

## Security Best Practices

### DO

- Use 1Password or pass for storing credentials
- Use `.template` files for configs with secrets
- Add `.env` to `.gitignore`
- Rotate secrets regularly
- Use SSH agent for SSH keys
- Enable 2FA on all accounts

### DON'T

- Commit secrets to git (even in private repos)
- Share secrets via email or Slack
- Store production secrets in `.env` files
- Hardcode secrets in scripts
- Leave secrets in shell history

---

## Troubleshooting

### "1Password CLI not signed in"

```bash
eval "$(op signin)"
op account list
```

### "Secret not found"

```bash
# Check structured item exists
op item get "ns-bootstrap" --vault=Personal

# List fields
op item get "ns-bootstrap" --vault=Personal --format=json | jq '.fields[] | {section: .section.label, label: .label}'

# Check what provider is available
secrets_available
```

### "pass not initialized"

```bash
gpg --list-keys
pass init YOUR_GPG_KEY_ID
```

---

## Reference

- **1Password CLI**: https://developer.1password.com/docs/cli/
- **pass**: https://www.passwordstore.org/
- **macOS Keychain**: `man security`
